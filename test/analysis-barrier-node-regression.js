'use strict'

const path = require('path')
const startpoint = require('startpoint')
const inspectpoint = require('inspectpoint')
const { FakeSystemInfo, FakeAggregateNode } = require('./analysis-util')

const WrapAsBarrierNodes = require('../analysis/barrier/wrap-as-barrier-nodes.js')
const MakeExternalBarrierNodes = require('../analysis/barrier/make-external-barrier-nodes.js')
const MakeSynchronousBarrierNodes = require('../analysis/barrier/make-synchronous-barrier-nodes.js')

const CombineAsClusterNodes = require('../analysis/cluster/combine-as-cluster-nodes.js')

function createTreeStructure () {
  const data = [
    new FakeAggregateNode({
      aggregateId: 1,
      parentAggregateId: 0,
      children: [ 9 ],
      isRoot: true,
      frames: []
    }),

    new FakeAggregateNode({
      aggregateId: 9,
      parentAggregateId: 1,
      children: [ 10, 11 ],
      mark: [ 'nodecore', 'net', 'onrequest' ],
      type: 'HTTPPARSER',
      frames:
       [ { functionName: 'connectionListenerInternal',
           isToplevel: true,
           fileName: '_http_server.js',
           lineNumber: 322,
           columnNumber: 10 },
         { functionName: 'connectionListener',
           typeName: 'Server',
           fileName: '_http_server.js',
           lineNumber: 299,
           columnNumber: 3 },
         { functionName: 'emit',
           typeName: 'Server',
           fileName: 'events.js',
           lineNumber: 136,
           columnNumber: 15 },
         { functionName: 'emit',
           typeName: 'Server',
           fileName: 'domain.js',
           lineNumber: 421,
           columnNumber: 20 },
         { functionName: 'onconnection',
           typeName: 'Pipe',
           fileName: 'net.js',
           lineNumber: 1619,
           columnNumber: 8 } ]
    }),

    new FakeAggregateNode({
      aggregateId: 10,
      parentAggregateId: 9,
      children: [ 12 ],
      mark: [ 'user', null, null ],
      type: 'Immediate',
      frames:
       [ { functionName: 'Immediate',
           isConstructor: true,
           fileName: 'timers.js',
           lineNumber: 749,
           columnNumber: 7 },
         { functionName: 'setImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 805,
           columnNumber: 10 },
         { functionName: 'createLargeLinkStructure',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 9,
           columnNumber: 3 },
         { functionName: 'getLargeData',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 23,
           columnNumber: 3 },
         { functionName: 'processRequest',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 39,
           columnNumber: 3 },
         { typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 53,
           columnNumber: 3 },
         { functionName: 'next',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 1125,
           columnNumber: 29 },
         { functionName: 'f',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/once/once.js',
           lineNumber: 36,
           columnNumber: 25 },
         { functionName: '_run',
           typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 1179,
           columnNumber: 16 },
         { functionName: '_route',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 825,
           columnNumber: 14 },
         { functionName: 'onRoute',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 939,
           columnNumber: 24 },
         { functionName: 'find',
           typeName: 'Router',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/router.js',
           lineNumber: 436,
           columnNumber: 9 },
         { functionName: '_route',
           typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 922,
           columnNumber: 28 },
         { functionName: '_routeAndRun',
           typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 816,
           columnNumber: 10 },
         { functionName: '_handle',
           typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 863,
           columnNumber: 14 },
         { functionName: 'onRequest',
           typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 214,
           columnNumber: 14 },
         { functionName: 'emit',
           typeName: 'Server',
           fileName: 'events.js',
           lineNumber: 131,
           columnNumber: 13 },
         { functionName: 'emit',
           typeName: 'Server',
           fileName: 'domain.js',
           lineNumber: 421,
           columnNumber: 20 },
         { functionName: 'parserOnIncoming',
           isToplevel: true,
           fileName: '_http_server.js',
           lineNumber: 628,
           columnNumber: 12 },
         { functionName: 'parserOnHeadersComplete',
           typeName: 'HTTPParser',
           fileName: '_http_common.js',
           lineNumber: 112,
           columnNumber: 17 } ]
    }),

    new FakeAggregateNode({
      aggregateId: 11,
      parentAggregateId: 9,
      children: [ 13 ],
      mark: [ 'user', null, null ],
      type: 'Immediate',
      frames:
       [ { functionName: 'Immediate',
           isConstructor: true,
           fileName: 'timers.js',
           lineNumber: 749,
           columnNumber: 7 },
         { functionName: 'setImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 805,
           columnNumber: 10 },
         { functionName: 'createLargeLinkStructure',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 9,
           columnNumber: 3 },
         { functionName: 'getLargeData',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 23,
           columnNumber: 3 },
         { functionName: 'processRequest',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 39,
           columnNumber: 3 },
         { typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 53,
           columnNumber: 3 },
         { functionName: 'next',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 1125,
           columnNumber: 29 },
         { functionName: 'f',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/once/once.js',
           lineNumber: 36,
           columnNumber: 25 },
         { functionName: '_run',
           typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 1179,
           columnNumber: 16 },
         { functionName: '_route',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 825,
           columnNumber: 14 },
         { functionName: 'onRoute',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 939,
           columnNumber: 24 },
         { functionName: 'find',
           typeName: 'Router',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/router.js',
           lineNumber: 551,
           columnNumber: 9 },
         { functionName: '_route',
           typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 922,
           columnNumber: 28 },
         { functionName: '_routeAndRun',
           typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 816,
           columnNumber: 10 },
         { functionName: '_handle',
           typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 863,
           columnNumber: 14 },
         { functionName: 'onRequest',
           typeName: 'Server',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/node_modules/restify/lib/server.js',
           lineNumber: 214,
           columnNumber: 14 },
         { functionName: 'emit',
           typeName: 'Server',
           fileName: 'events.js',
           lineNumber: 131,
           columnNumber: 13 },
         { functionName: 'emit',
           typeName: 'Server',
           fileName: 'domain.js',
           lineNumber: 421,
           columnNumber: 20 },
         { functionName: 'parserOnIncoming',
           isToplevel: true,
           fileName: '_http_server.js',
           lineNumber: 628,
           columnNumber: 12 },
         { functionName: 'parserOnHeadersComplete',
           typeName: 'HTTPParser',
           fileName: '_http_common.js',
           lineNumber: 112,
           columnNumber: 17 } ]
    }),

    new FakeAggregateNode({
      aggregateId: 12,
      parentAggregateId: 10,
      children: [ 14 ],
      mark: [ 'user', null, null ],
      type: 'Immediate',
      frames:
       [ { functionName: 'Immediate',
           isConstructor: true,
           fileName: 'timers.js',
           lineNumber: 749,
           columnNumber: 7 },
         { functionName: 'setImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 805,
           columnNumber: 10 },
         { functionName: 'createLargeLinkStructure',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 9,
           columnNumber: 3 },
         { typeName: 'Immediate',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 13,
           columnNumber: 7 },
         { functionName: 'runCallback',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 729,
           columnNumber: 18 },
         { functionName: 'tryOnImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 700,
           columnNumber: 5 },
         { functionName: 'processImmediate',
           typeName: 'process',
           fileName: 'timers.js',
           lineNumber: 682,
           columnNumber: 5 },
         { functionName: 'topLevelDomainCallback',
           typeName: 'process',
           fileName: 'domain.js',
           lineNumber: 101,
           columnNumber: 23 } ]
    }),

    new FakeAggregateNode({
      aggregateId: 13,
      parentAggregateId: 11,
      children: [ 15 ],
      mark: [ 'user', null, null ],
      type: 'Immediate',
      frames:
       [ { functionName: 'Immediate',
           isConstructor: true,
           fileName: 'timers.js',
           lineNumber: 749,
           columnNumber: 7 },
         { functionName: 'setImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 805,
           columnNumber: 10 },
         { functionName: 'createLargeLinkStructure',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 9,
           columnNumber: 3 },
         { typeName: 'Immediate',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 13,
           columnNumber: 7 },
         { functionName: 'runCallback',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 729,
           columnNumber: 18 },
         { functionName: 'tryOnImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 700,
           columnNumber: 5 },
         { functionName: 'processImmediate',
           typeName: 'process',
           fileName: 'timers.js',
           lineNumber: 682,
           columnNumber: 5 },
         { functionName: 'topLevelDomainCallback',
           typeName: 'process',
           fileName: 'domain.js',
           lineNumber: 101,
           columnNumber: 23 } ]
    }),

    new FakeAggregateNode({
      aggregateId: 14,
      parentAggregateId: 12,
      children: [ 16 ],
      mark: [ 'user', null, null ],
      type: 'Immediate',
      frames:
       [ { functionName: 'Immediate',
           isConstructor: true,
           fileName: 'timers.js',
           lineNumber: 749,
           columnNumber: 7 },
         { functionName: 'setImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 805,
           columnNumber: 10 },
         { functionName: 'createLargeLinkStructure',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 9,
           columnNumber: 3 },
         { typeName: 'Immediate',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 13,
           columnNumber: 7 },
         { functionName: 'runCallback',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 729,
           columnNumber: 18 },
         { functionName: 'tryOnImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 700,
           columnNumber: 5 },
         { functionName: 'processImmediate',
           typeName: 'process',
           fileName: 'timers.js',
           lineNumber: 682,
           columnNumber: 5 },
         { functionName: 'topLevelDomainCallback',
           typeName: 'process',
           fileName: 'domain.js',
           lineNumber: 101,
           columnNumber: 23 } ]
    }),

    new FakeAggregateNode({
      aggregateId: 15,
      parentAggregateId: 13,
      children: [ 17 ],
      mark: [ 'user', null, null ],
      type: 'Immediate',
      frames:
       [ { functionName: 'Immediate',
           isConstructor: true,
           fileName: 'timers.js',
           lineNumber: 749,
           columnNumber: 7 },
         { functionName: 'setImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 805,
           columnNumber: 10 },
         { functionName: 'createLargeLinkStructure',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 9,
           columnNumber: 3 },
         { typeName: 'Immediate',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 13,
           columnNumber: 7 },
         { functionName: 'runCallback',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 729,
           columnNumber: 18 },
         { functionName: 'tryOnImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 700,
           columnNumber: 5 },
         { functionName: 'processImmediate',
           typeName: 'process',
           fileName: 'timers.js',
           lineNumber: 682,
           columnNumber: 5 },
         { functionName: 'topLevelDomainCallback',
           typeName: 'process',
           fileName: 'domain.js',
           lineNumber: 101,
           columnNumber: 23 } ]
    }),

    new FakeAggregateNode({
      aggregateId: 16,
      parentAggregateId: 14,
      children: [ 18 ],
      mark: [ 'user', null, null ],
      type: 'Immediate',
      frames:
       [ { functionName: 'Immediate',
           isConstructor: true,
           fileName: 'timers.js',
           lineNumber: 749,
           columnNumber: 7 },
         { functionName: 'setImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 805,
           columnNumber: 10 },
         { functionName: 'createLargeLinkStructure',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 9,
           columnNumber: 3 },
         { typeName: 'Immediate',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 13,
           columnNumber: 7 },
         { functionName: 'runCallback',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 729,
           columnNumber: 18 },
         { functionName: 'tryOnImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 700,
           columnNumber: 5 },
         { functionName: 'processImmediate',
           typeName: 'process',
           fileName: 'timers.js',
           lineNumber: 682,
           columnNumber: 5 },
         { functionName: 'topLevelDomainCallback',
           typeName: 'process',
           fileName: 'domain.js',
           lineNumber: 101,
           columnNumber: 23 } ]
    }),

    new FakeAggregateNode({
      aggregateId: 17,
      parentAggregateId: 15,
      children: [ 19 ],
      mark: [ 'user', null, null ],
      type: 'Immediate',
      frames:
       [ { functionName: 'Immediate',
           isConstructor: true,
           fileName: 'timers.js',
           lineNumber: 749,
           columnNumber: 7 },
         { functionName: 'setImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 805,
           columnNumber: 10 },
         { functionName: 'createLargeLinkStructure',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 9,
           columnNumber: 3 },
         { typeName: 'Immediate',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 13,
           columnNumber: 7 },
         { functionName: 'runCallback',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 729,
           columnNumber: 18 },
         { functionName: 'tryOnImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 700,
           columnNumber: 5 },
         { functionName: 'processImmediate',
           typeName: 'process',
           fileName: 'timers.js',
           lineNumber: 682,
           columnNumber: 5 },
         { functionName: 'topLevelDomainCallback',
           typeName: 'process',
           fileName: 'domain.js',
           lineNumber: 101,
           columnNumber: 23 } ]
    }),

    new FakeAggregateNode({
      aggregateId: 18,
      parentAggregateId: 16,
      children: [ ],
      mark: [ 'user', null, null ],
      type: 'Immediate',
      frames:
       [ { functionName: 'Immediate',
           isConstructor: true,
           fileName: 'timers.js',
           lineNumber: 749,
           columnNumber: 7 },
         { functionName: 'setImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 805,
           columnNumber: 10 },
         { functionName: 'createLargeLinkStructure',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 9,
           columnNumber: 3 },
         { typeName: 'Immediate',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 13,
           columnNumber: 7 },
         { functionName: 'runCallback',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 729,
           columnNumber: 18 },
         { functionName: 'tryOnImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 700,
           columnNumber: 5 },
         { functionName: 'processImmediate',
           typeName: 'process',
           fileName: 'timers.js',
           lineNumber: 682,
           columnNumber: 5 },
         { functionName: 'topLevelDomainCallback',
           typeName: 'process',
           fileName: 'domain.js',
           lineNumber: 101,
           columnNumber: 23 } ]
    }),

    new FakeAggregateNode({
      aggregateId: 19,
      parentAggregateId: 17,
      children: [ ],
      mark: [ 'user', null, null ],
      type: 'Immediate',
      frames:
       [ { functionName: 'Immediate',
           isConstructor: true,
           fileName: 'timers.js',
           lineNumber: 749,
           columnNumber: 7 },
         { functionName: 'setImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 805,
           columnNumber: 10 },
         { functionName: 'createLargeLinkStructure',
           isToplevel: true,
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 9,
           columnNumber: 3 },
         { typeName: 'Immediate',
           fileName: '/Users/Andreas/Sites/clinic/node_modules/@nearform/clinic-bubbleprof/test/servers/bug.js',
           lineNumber: 13,
           columnNumber: 7 },
         { functionName: 'runCallback',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 729,
           columnNumber: 18 },
         { functionName: 'tryOnImmediate',
           isToplevel: true,
           fileName: 'timers.js',
           lineNumber: 700,
           columnNumber: 5 },
         { functionName: 'processImmediate',
           typeName: 'process',
           fileName: 'timers.js',
           lineNumber: 682,
           columnNumber: 5 },
         { functionName: 'topLevelDomainCallback',
           typeName: 'process',
           fileName: 'domain.js',
           lineNumber: 101,
           columnNumber: 23 } ]
    })
  ]

  return startpoint(data.sort((a, b) => a.aggregateId - b.aggregateId), { objectMode: true })
}

const systemInfo = new FakeSystemInfo(path.resolve(__dirname, 'servers'))

createTreeStructure()
  .pipe(new WrapAsBarrierNodes())
  .pipe(new MakeSynchronousBarrierNodes(systemInfo))
  .pipe(new MakeExternalBarrierNodes(systemInfo))
  .pipe(new CombineAsClusterNodes())
  .pipe(inspectpoint({ depth: null, colors: true }))
  .pipe(process.stdout)
